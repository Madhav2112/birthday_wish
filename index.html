<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cosmic Charades</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light only" />

  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      color-scheme: light;
      -webkit-text-size-adjust: 100%;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at 20% 0%, #3b1d6b, #050513 60%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      color: #ffffff;
      overflow-x: hidden;
      overflow-y: auto;
    }

    .module-wrapper {
      position: relative;
      width: 100vw;
      min-height: 100vh;
      overflow: hidden;
    }

    /* Cosmic background layers */
    .stars-layer {
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,0.25) 0, transparent 40%),
        radial-gradient(circle at 80% 30%, rgba(255,200,255,0.18) 0, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(150,200,255,0.16) 0, transparent 45%);
      opacity: 0.6;
      pointer-events: none;
    }

    .nebula-layer {
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 15% 70%, rgba(200,100,255,0.32), transparent 60%),
        radial-gradient(circle at 80% 20%, rgba(100,180,255,0.25), transparent 55%);
      mix-blend-mode: screen;
      opacity: 0.9;
      pointer-events: none;
    }

    .vignette {
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 50% 20%, transparent 0, transparent 40%, rgba(0,0,0,0.35) 80%);
      pointer-events: none;
    }

    /* Shared center layout */
    .center-layout {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      text-align: center;
    }

    /* Identity screen */
    .identity-screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: radial-gradient(circle at 50% 10%, rgba(255,255,255,0.12), transparent 55%);
      z-index: 5;
    }

    .identity-card {
      background: rgba(10, 6, 28, 0.9);
      border-radius: 24px;
      padding: 24px 20px 20px;
      max-width: 420px;
      width: 100%;
      box-shadow:
        0 0 25px rgba(255, 160, 255, 0.4),
        0 0 80px rgba(80, 160, 255, 0.35);
      border: 1px solid rgba(255, 210, 255, 0.4);
      backdrop-filter: blur(18px);
    }

    .identity-title {
      font-size: 1.1rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #ffdfff;
      margin-bottom: 10px;
    }

    .identity-line {
      font-size: 1.5rem;
      margin-bottom: 12px;
    }

    .identity-subtitle {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 20px;
    }

    .input-row {
      display: flex;
      flex-direction: row;
      gap: 10px;
      margin-bottom: 8px;
    }

    .input-row input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 200, 255, 0.7);
      background: rgba(5, 2, 18, 0.9);
      color: #ffffff;
      font-size: 1rem;
      outline: none;
    }

    .input-row input::placeholder {
      color: rgba(255, 220, 255, 0.6);
    }

    .start-button {
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      background: linear-gradient(135deg, #ff89ff, #7f6dff);
      color: #0b0414;
      font-weight: 600;
      box-shadow:
        0 0 20px rgba(255, 140, 255, 0.8),
        0 0 40px rgba(120, 160, 255, 0.4);
    }

    .start-button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .identity-status {
      font-size: 0.8rem;
      margin-top: 6px;
      min-height: 18px;
      color: #ffd7ff;
      opacity: 0.8;
    }

    /* Game screen */
    .game-screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      opacity: 0;
      pointer-events: none;
      z-index: 1; /* prevents overlap under completion */
    }

    .hud-top {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #ffdfff;
      opacity: 0.9;
    }

    .hud-progress-bar {
      width: 180px;
      height: 5px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.12);
      overflow: hidden;
    }

    .hud-progress-fill {
      width: 0%;
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #ffb7ff, #8fd3ff);
    }

    .cosmic-character-wrapper {
      position: relative;
      width: 220px;
      height: 220px;
      margin-bottom: 22px;
    }

    .character-orbit {
      position: absolute;
      inset: 10%;
      border-radius: 50%;
      border: 1px dashed rgba(255, 230, 255, 0.2);
    }

    .cosmic-character {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 120px;
      height: 120px;
      transform: translate(-50%, -50%);
    }

    .char-aura {
      position: absolute;
      inset: -25%;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 170, 255, 0.6), transparent 70%);
      filter: blur(2px);
    }

    .char-body {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 80px;
      height: 90px;
      transform: translate(-50%, -50%);
      border-radius: 50px 50px 40px 40px;
      background: radial-gradient(circle at 30% 25%, #ffffff, #ffc8ff 60%, #a98cff 100%);
      box-shadow:
        0 0 16px rgba(255, 190, 255, 0.9),
        0 0 35px rgba(140, 180, 255, 0.7);
      -webkit-filter: none !important;
      filter: none !important;
      mix-blend-mode: normal;
    }

    .char-bottom-wave {
      position: absolute;
      left: 50%;
      bottom: -8px;
      width: 80px;
      height: 24px;
      transform: translateX(-50%);
      background:
        radial-gradient(circle at 10% 0, rgba(255,255,255,0.9), transparent 60%),
        radial-gradient(circle at 45% 0, rgba(255,255,255,0.9), transparent 60%),
        radial-gradient(circle at 80% 0, rgba(255,255,255,0.9), transparent 60%);
      mask-image: radial-gradient(circle at 50% 0, black 0, black 60%, transparent 75%);
      opacity: 0.95;
    }

    .char-eye {
      position: absolute;
      top: 36%;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #1c1030;
      box-shadow: 0 0 4px rgba(0,0,0,0.6);
    }

    .char-eye.left { left: 35%; }
    .char-eye.right { right: 35%; }

    .char-eye .sparkle {
      position: absolute;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #ffffff;
      top: 3px;
      left: 3px;
      opacity: 0.9;
    }

    .char-mouth {
      position: absolute;
      top: 56%;
      left: 50%;
      width: 30px;
      height: 18px;
      transform: translateX(-50%);
      border-bottom: 3px solid #201030;
      border-radius: 0 0 30px 30px;
    }

    .char-blush {
      position: absolute;
      top: 52%;
      width: 16px;
      height: 10px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,120,170,0.8), transparent 70%);
      opacity: 0.9;
    }

    .char-blush.left { left: 15%; }
    .char-blush.right { right: 15%; }

    /* Question and options */
    .question-text {
      font-size: 1.2rem;
      margin-bottom: 10px;
    }

    .hint-line {
      font-size: 0.85rem;
      opacity: 0.75;
      margin-bottom: 16px;
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      max-width: 340px;
    }

    .option-button {
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid rgba(255, 220, 255, 0.7);
      background: rgba(13, 6, 30, 0.9);
      color: #ffffff;
      cursor: pointer;
      font-size: 0.95rem;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
    }

    .option-button.correct {
      background: linear-gradient(135deg, #b9ffb5, #6fd9ff);
      color: #051020;
      box-shadow:
        0 0 18px rgba(160,255,200,0.9),
        0 0 40px rgba(130,210,255,0.7);
    }

    .option-button.wrong {
      background: radial-gradient(circle, #ff8a8a, #7a1a24);
      box-shadow:
        0 0 18px rgba(255,120,120,0.8),
        0 0 26px rgba(110,20,40,0.7);
    }

    .option-button:active {
      transform: scale(0.97);
    }

    .feedback-text {
      margin-top: 10px;
      min-height: 20px;
      font-size: 0.85rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      opacity: 0.8;
    }

    .footer-hint {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.75rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #ffdfff;
      opacity: 0.7;
    }

    /* Completion overlay */
    .completion-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 50% 20%, rgba(255,255,255,0.2), rgba(1,0,10,0.96));
      opacity: 0;
      pointer-events: none;
      z-index: 10; /* ensures it covers everything */
    }

    .completion-card {
      background: rgba(12, 6, 28, 0.95);
      border-radius: 24px;
      padding: 24px 18px 20px;
      max-width: 360px;
      width: 100%;
      text-align: center;
      border: 1px solid rgba(210, 230, 255, 0.7);
      box-shadow:
        0 0 26px rgba(180, 220, 255, 0.7),
        0 0 70px rgba(160, 140, 255, 0.8);
    }

    .completion-title {
      font-size: 1.4rem;
      margin-bottom: 8px;
    }

    .completion-text {
      font-size: 0.95rem;
      opacity: 0.85;
      margin-bottom: 18px;
    }

    .next-button {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #9cfaff, #ffb8ff);
      color: #080415;
      font-size: 0.95rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
      box-shadow:
        0 0 22px rgba(170, 240, 255, 0.9),
        0 0 40px rgba(255, 190, 255, 0.7);
    }

    /* Particle container */
    .particle-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 5;
    }

    .particle {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: radial-gradient(circle, #ffffff, #ffe4ff 60%, transparent 100%);
      box-shadow:
        0 0 10px rgba(255,255,255,0.9),
        0 0 25px rgba(180,210,255,0.9);
    }

    /* Responsive tweaks */
    @media (max-width: 480px) {
      .identity-card {
        padding: 20px 16px 16px;
      }

      .identity-line {
        font-size: 1.3rem;
      }

      .cosmic-character-wrapper {
        width: 190px;
        height: 190px;
      }

      .question-text {
        font-size: 1.05rem;
      }

      .options {
        max-width: 100%;
      }
    }
  </style>
</head>

<body>
<div class="module-wrapper">
  <!-- Background -->
  <div class="stars-layer"></div>
  <div class="nebula-layer"></div>
  <div class="vignette"></div>

  <!-- Particle layer -->
  <div class="particle-layer" id="particleLayer"></div>
  <!-- Identity screen -->
  <div class="identity-screen" id="identityScreen">
    <div class="identity-card">
      <div class="identity-title">Module 1 – Cosmic Charades</div>
      <div class="identity-line">Type your name to begin ✨</div>
      <div class="identity-subtitle">
        A tiny cosmic spirit wants to know who’s watching before it starts acting out secrets from the stars.
      </div>

      <form id="identityForm">
        <div class="input-row">
          <input
            type="text"
            id="playerName"
            name="playerName"
            placeholder="Your name"
            autocomplete="name"
            required
          />
          <button type="submit" class="start-button" id="startButton">
            Begin
          </button>
        </div>
      </form>

      <div class="identity-status" id="identityStatus"></div>
    </div>
  </div>

  <!-- Game screen -->
  <div class="game-screen center-layout" id="gameScreen">
    <div class="hud-top">
      <div id="hudRound">Round 1 of 5</div>
      <div class="hud-progress-bar">
        <div class="hud-progress-fill" id="progressFill"></div>
      </div>
    </div>

    <div class="cosmic-character-wrapper">
      <div class="character-orbit"></div>
      <div class="cosmic-character" id="cosmicCharacter">
        <div class="char-aura"></div>
        <div class="char-body">
          <div class="char-eye left"><div class="sparkle"></div></div>
          <div class="char-eye right"><div class="sparkle"></div></div>
          <div class="char-mouth"></div>
          <div class="char-blush left"></div>
          <div class="char-blush right"></div>
          <div class="char-bottom-wave"></div>
        </div>
      </div>
    </div>

    <div class="question-text" id="questionText">What is the spirit doing?</div>
    <div class="hint-line" id="hintLine">Watch closely, then choose the closest answer.</div>

    <div class="options" id="optionsContainer"></div>

    <div class="feedback-text" id="feedbackText"></div>

    <div class="footer-hint">
      Trust your instincts. Cosmic charades never lies.
    </div>
  </div>

  <!-- Completion overlay -->
  <div class="completion-overlay" id="completionOverlay">
    <div class="completion-card">
      <div class="completion-title">Awakening complete ✨</div>
      <div class="completion-text">
        You read the spirit perfectly. The path to the next mystery opens softly in front of you.
      </div>
      <button class="next-button" id="nextModuleButton">
        Continue
      </button>
    </div>
  </div>

</div> <!-- end module-wrapper -->
</body>

<script>
/***********************
 * CONFIG
 ***********************/
const LOG_ENDPOINT = "/.netlify/functions/logIdentity";
const NEXT_MODULE_URL = "module2.html";

/***********************
 * ELEMENTS
 ***********************/
const identityForm = document.getElementById("identityForm");
const playerNameInput = document.getElementById("playerName");
const identityStatus = document.getElementById("identityStatus");
const identityScreen = document.getElementById("identityScreen");
const gameScreen = document.getElementById("gameScreen");
const startButton = document.getElementById("startButton");

const questionText = document.getElementById("questionText");
const hintLine = document.getElementById("hintLine");
const optionsContainer = document.getElementById("optionsContainer");
const feedbackText = document.getElementById("feedbackText");
const hudRound = document.getElementById("hudRound");
const progressFill = document.getElementById("progressFill");
const cosmicCharacter = document.getElementById("cosmicCharacter");
const particleLayer = document.getElementById("particleLayer");
const completionOverlay = document.getElementById("completionOverlay");
const nextModuleButton = document.getElementById("nextModuleButton");

let playerName = "";
let currentRound = 0;
let correctCount = 0;
let isAnimating = false;
let bonusAnswered = false;

/***********************
 * 8 ROUNDS — FIXED OPTIONS (NOT ALWAYS FIRST)
 ***********************/
const charades = [
  {
    id: "dancing",
    question: "What is the spirit trying to show you?",
    hint: "Its body sways, hops, and wiggles to a hidden beat.",
    options: ["Jumping", "Waving", "Dancing"],
    correct: "Dancing",
    animation: animateDancing
  },
  {
    id: "jumping",
    question: "And now?",
    hint: "It leaps upward with a twist, as if gravity is optional.",
    options: ["Falling", "Jumping", "Dancing"],
    correct: "Jumping",
    animation: animateJumping
  },
  {
    id: "sleeping",
    question: "What mood is this?",
    hint: "It sinks slowly, twitches once, then drifts again.",
    options: ["Thinking", "Pretending to sleep", "Resting"],
    correct: "Pretending to sleep",
    animation: animateSleeping
  },
  {
    id: "bunny",
    question: "What creature is it acting like?",
    hint: "Tiny hops, tiny nose wiggles, tiny head tilt.",
    options: ["Mouse", "Bunny", "Cat"],
    correct: "Bunny",
    animation: animateBunny
  },
  {
    id: "excited",
    question: "What feeling is glowing through it?",
    hint: "It jitters, bounces, and can’t stay still.",
    options: ["Nervous", "Excited", "Angry"],
    correct: "Excited",
    animation: animateExcited
  },
  {
    id: "shy",
    question: "What is it doing now?",
    hint: "It hides, peeks, hides again… unsure but curious.",
    options: ["Scared", "Shy", "Hiding"],
    correct: "Shy",
    animation: animateShy
  },
  {
    id: "dizzy",
    question: "What state is it in?",
    hint: "It spins slowly, wobbles, then steadies itself.",
    options: ["Balancing", "Dizzy", "Spinning"],
    correct: "Dizzy",
    animation: animateDizzy
  },
  {
    id: "waving",
    question: "What is it trying to do?",
    hint: "It leans forward and waves as if calling someone.",
    options: ["Reaching", "Calling", "Waving"],
    correct: "Waving",
    animation: animateWaving
  }
];

/***********************
 * GAME FLOW
 ***********************/
function initGame() {
  currentRound = 0;
  correctCount = 0;
  bonusAnswered = false;
  updateProgress();
  loadRound();
}

function updateProgress() {
  hudRound.textContent = "Round " + (currentRound + 1) + " of " + charades.length;
  const percentage = (correctCount / charades.length) * 100;
  progressFill.style.width = percentage + "%";
}

function resetCharacterPose() {
  gsap.killTweensOf(cosmicCharacter);
  gsap.set(cosmicCharacter, { x: 0, y: 0, rotation: 0, scale: 1 });
}

function loadRound() {
  const data = charades[currentRound];
  feedbackText.textContent = "";
  resetCharacterPose();

  questionText.textContent = data.question;
  hintLine.textContent = data.hint;

  optionsContainer.innerHTML = "";
  data.options.forEach(optionText => {
    const btn = document.createElement("button");
    btn.className = "option-button";
    btn.textContent = optionText;
    btn.addEventListener("click", () => handleAnswer(optionText, data));
    optionsContainer.appendChild(btn);
  });

  data.animation();
}

/***********************
 * ANSWER HANDLING
 ***********************/
function disableOptions() {
  const buttons = optionsContainer.querySelectorAll("button");
  buttons.forEach(btn => (btn.disabled = true));
}

function handleAnswer(selected, data) {
  if (isAnimating) return;
  isAnimating = true;

  disableOptions();

  const buttons = optionsContainer.querySelectorAll("button");
  buttons.forEach(btn => {
    if (btn.textContent === data.correct && selected === data.correct) {
      btn.classList.add("correct");
    } else if (btn.textContent === selected) {
      btn.classList.add("wrong");
    }
  });

  if (selected === data.correct) {
    correctCount++;
    feedbackText.textContent = "Yes. You felt that perfectly.";
    triggerSparkleBurst();
  } else {
    feedbackText.textContent = "Close, but the spirit meant something else.";
  }

  updateProgress();

  setTimeout(() => {
    currentRound++;
    if (currentRound >= charades.length) {
      showBonusRound();
    } else {
      loadRound();
    }
    isAnimating = false;
  }, 1200);
}

/***********************
 * ANIMATIONS (8 TOTAL)
 ***********************/
function animateDancing() {
  resetCharacterPose();
  const tl = gsap.timeline({ repeat: -1 });
  tl.to(cosmicCharacter, { rotation: 8, y: -6, duration: 0.35 })
    .to(cosmicCharacter, { rotation: -8, y: -2, duration: 0.35 })
    .to(cosmicCharacter, { rotation: 4, y: -4, duration: 0.3 });
}

function animateJumping() {
  resetCharacterPose();
  gsap.to(cosmicCharacter, {
    y: -32,
    rotation: 8,
    duration: 0.4,
    yoyo: true,
    repeat: -1
  });
}

function animateSleeping() {
  resetCharacterPose();
  gsap.to(cosmicCharacter, {
    y: 6,
    scale: 0.96,
    duration: 1.4,
    yoyo: true,
    repeat: -1
  });
  gsap.to(cosmicCharacter, {
    rotation: -5,
    duration: 2.2,
    yoyo: true,
    repeat: -1
  });
}

function animateBunny() {
  resetCharacterPose();
  const tl = gsap.timeline({ repeat: -1 });
  tl.to(cosmicCharacter, { y: -16, duration: 0.25 })
    .to(cosmicCharacter, { y: 0, duration: 0.25 })
    .to(cosmicCharacter, { x: 8, duration: 0.25 })
    .to(cosmicCharacter, { x: -8, duration: 0.25 })
    .to(cosmicCharacter, { x: 0, duration: 0.25 });
}

function animateExcited() {
  resetCharacterPose();
  gsap.to(cosmicCharacter, {
    scale: 1.06,
    y: -12,
    duration: 0.22,
    yoyo: true,
    repeat: -1
  });
  gsap.to(cosmicCharacter, {
    rotation: 5,
    duration: 0.22,
    yoyo: true,
    repeat: -1
  });
}

function animateShy() {
  resetCharacterPose();
  const tl = gsap.timeline({ repeat: -1 });
  tl.to(cosmicCharacter, { x: -20, opacity: 0.4, duration: 0.5 })
    .to(cosmicCharacter, { x: 0, opacity: 1, duration: 0.5 })
    .to(cosmicCharacter, { x: 20, opacity: 0.4, duration: 0.5 })
    .to(cosmicCharacter, { x: 0, opacity: 1, duration: 0.5 });
}

function animateDizzy() {
  resetCharacterPose();
  gsap.to(cosmicCharacter, {
    rotation: 360,
    duration: 2.2,
    repeat: -1,
    ease: "none"
  });
  gsap.to(cosmicCharacter, {
    y: -6,
    duration: 0.5,
    yoyo: true,
    repeat: -1
  });
}

function animateWaving() {
  resetCharacterPose();
  const tl = gsap.timeline({ repeat: -1 });
  tl.to(cosmicCharacter, { rotation: -10, duration: 0.4 })
    .to(cosmicCharacter, { rotation: 10, duration: 0.4 })
    .to(cosmicCharacter, { rotation: 0, duration: 0.3 });
}

/***********************
 * NORMAL SPARKLES
 ***********************/
function triggerSparkleBurst() {
  const rect = cosmicCharacter.getBoundingClientRect();
  const centerX = rect.left + rect.width / 2;
  const centerY = rect.top + rect.height / 2;

  const count = 16;
  for (let i = 0; i < count; i++) {
    const p = document.createElement("div");
    p.className = "particle";
    particleLayer.appendChild(p);

    const angle = (Math.PI * 2 * i) / count;
    const distance = 40 + Math.random() * 40;

    const startX = centerX - particleLayer.getBoundingClientRect().left;
    const startY = centerY - particleLayer.getBoundingClientRect().top;
    const endX = startX + Math.cos(angle) * distance;
    const endY = startY + Math.sin(angle) * distance;

    gsap.set(p, { x: startX, y: startY, scale: 0.7 + Math.random() * 0.6 });

    gsap.to(p, {
      x: endX,
      y: endY,
      opacity: 0,
      scale: 0.2,
      duration: 0.8 + Math.random() * 0.5,
      onComplete: () => p.remove()
    });
  }
}

/***********************
 * BONUS ROUND (POP-UP MODAL)
 ***********************/
function showBonusRound() {
  gsap.killTweensOf(cosmicCharacter);

  const modalBg = document.createElement("div");
  modalBg.id = "bonusModalBg";
  Object.assign(modalBg.style, {
    position: "absolute",
    inset: "0",
    background: "rgba(0,0,0,0.65)",
    backdropFilter: "blur(6px)",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    zIndex: "20",
    opacity: "0"
  });

  const modal = document.createElement("div");
  Object.assign(modal.style, {
    background: "rgba(20,10,40,0.95)",
    border: "1px solid rgba(255,220,255,0.6)",
    borderRadius: "20px",
    padding: "22px 18px",
    width: "90%",
    maxWidth: "360px",
    textAlign: "center",
    boxShadow: "0 0 25px rgba(255,200,255,0.6), 0 0 60px rgba(120,160,255,0.5)"
  });

  const title = document.createElement("div");
  title.textContent = "Bonus Memory Round ✨";
  title.style.fontSize = "1.3rem";
  title.style.marginBottom = "10px";

  const q = document.createElement("div");
  q.textContent = "Earlier, in Round 2, what was the spirit doing?";
  q.style.fontSize = "1rem";
  q.style.marginBottom = "16px";
  q.style.opacity = "0.9";

  const opts = document.createElement("div");
  opts.style.display = "flex";
  opts.style.flexDirection = "column";
  opts.style.gap = "10px";

  const bonusOptions = ["Jumping", "Dancing", "Pretending to sleep"];
  const correctBonus = "Jumping";

  bonusOptions.forEach(text => {
    const btn = document.createElement("button");
    btn.textContent = text;
    btn.className = "option-button";

    btn.addEventListener("click", () => {
      if (bonusAnswered) return;
      bonusAnswered = true;

      if (text === correctBonus) {
        btn.classList.add("correct");
        triggerCosmicConfetti();
        showBonusMessage("Correct! Your memory is sharp.");
      } else {
        btn.classList.add("wrong");
        showBonusMessage("Not quite — but the spirit still smiles.");
      }

      setTimeout(() => {
        gsap.to(modalBg, {
          opacity: 0,
          duration: 0.5,
          onComplete: () => {
            modalBg.remove();
            showCompletion();
          }
        });
      }, 1600);
    });

    opts.appendChild(btn);
  });

  modal.appendChild(title);
  modal.appendChild(q);
  modal.appendChild(opts);
  modalBg.appendChild(modal);
  document.body.appendChild(modalBg);

  gsap.to(modalBg, { opacity: 1, duration: 0.5 });
}

function showBonusMessage(msg) {
  const m = document.createElement("div");
  m.textContent = msg;
  Object.assign(m.style, {
    marginTop: "14px",
    fontSize: "0.9rem",
    opacity: "0",
    color: "#ffdfff"
  });

  const modal = document.querySelector("#bonusModalBg > div");
  modal.appendChild(m);

  gsap.to(m, { opacity: 1, duration: 0.4 });
}

/***********************
 * COSMIC CONFETTI (SOFT)
 ***********************/
function triggerCosmicConfetti() {
  const rect = cosmicCharacter.getBoundingClientRect();
  const centerX = rect.left + rect.width / 2;
  const centerY = rect.top + rect.height / 2;

  const count = 22;
  for (let i = 0; i < count; i++) {
    const p = document.createElement("div");
    p.className = "particle";
    particleLayer.appendChild(p);

    const angle = (Math.PI * 2 * i) / count;
    const distance = 60 + Math.random() * 40;

    const startX = centerX - particleLayer.getBoundingClientRect().left;
    const startY = centerY - particleLayer.getBoundingClientRect().top;
    const endX = startX + Math.cos(angle) * distance;
    const endY = startY + Math.sin(angle) * distance;

    gsap.set(p, {
      x: startX,
      y: startY,
      scale: 0.8 + Math.random() * 0.6,
      background:
        "radial-gradient(circle, rgba(255,255,255,1), rgba(255,200,255,0.6), transparent)"
    });

    gsap.to(p, {
      x: endX,
      y: endY,
      opacity: 0,
      scale: 0.2,
      duration: 1 + Math.random() * 0.6,
      ease: "power2.out",
      onComplete: () => p.remove()
    });
  }
}

/***********************
 * COMPLETION OVERLAY
 ***********************/
function showCompletion() {
  completionOverlay.style.pointerEvents = "auto";
  gameScreen.style.display = "none";

  gsap.to(completionOverlay, {
    opacity: 1,
    duration: 0.8
  });

  setTimeout(() => {
    window.location.href = NEXT_MODULE_URL;
  }, 4000);
}

nextModuleButton.addEventListener("click", () => {
  gsap.to(".module-wrapper", {
    opacity: 0,
    duration: 0.7,
    onComplete: () => {
      window.location.href = NEXT_MODULE_URL;
    }
  });
});

/***********************
 * LOGGING
 ***********************/
function getDeviceType() {
  const ua = navigator.userAgent;
  if (/iPhone|iPad|iPod/i.test(ua)) return "iPhone";
  if (/android/i.test(ua)) return "Android";
  if (/Mobi|Android/i.test(ua)) return "Mobile";
  return "Desktop";
}

function getBrowserName() {
  const ua = navigator.userAgent;
  if (/chrome|crios|crmo/i.test(ua) && !/edge|edg/i.test(ua)) return "Chrome";
  if (/edg/i.test(ua)) return "Edge";
  if (/firefox|fxios/i.test(ua)) return "Firefox";
  if (/safari/i.test(ua) && !/chrome|crios|crmo/i.test(ua)) return "Safari";
  return "Unknown";
}

function simpleFingerprintHash() {
  const data = [
    navigator.userAgent,
    screen.width,
    screen.height,
    screen.colorDepth,
    navigator.language,
    Intl.DateTimeFormat().resolvedOptions().timeZone || ""
  ].join("::");

  let hash = 0;
  for (let i = 0; i < data.length; i++) {
    hash = ((hash << 5) - hash) + data.charCodeAt(i);
    hash |= 0;
  }
  return "fp_" + (hash >>> 0).toString(16);
}

async function fetchGeoInfo() {
  try {
    const token = "349bdfae7f1a3a";
    const res = await fetch(`https://ipinfo.io/json?token=${token}`);
    const data = await res.json();
    return {
      ip: data.ip || null,
      city: data.city || null,
      region: data.region || null,
      country: data.country || null,
      isp: data.org || null
    };
  } catch {
    return { ip: null, city: null, region: null, country: null, isp: null };
  }
}
function updateSession(moduleName) {
  if (!localStorage.getItem("sessionId")) {
    localStorage.setItem("sessionId", crypto.randomUUID());
  }

  fetch("/.netlify/functions/session-check", {
    method: "POST",
    body: JSON.stringify({
      sessionId: localStorage.getItem("sessionId"),
      module: moduleName
    })
  });
}

const HER_NAME = "Aarushi"; // change to her exact spelling

function sendNotification(name, moduleName) {
  const isHer = name.toLowerCase() === HER_NAME.toLowerCase();

  fetch("/.netlify/functions/notify", {
    method: "POST",
    body: JSON.stringify({
      name,
      module: moduleName,
      isHer
    })
  });
}


async function logIdentity(name) {
  const geo = await fetchGeoInfo();

  const payload = {
    timestamp: new Date().toISOString(),
    name,
    city: geo.city,
    region: geo.region,
    country: geo.country,
    isp: geo.isp,
    deviceType: getDeviceType(),
    browser: getBrowserName(),
    screenSize: screen.width + "x" + screen.height,
    fingerprint: simpleFingerprintHash()
  };

  // Save to Google Sheet
  fetch("/.netlify/functions/save-to-sheet", {
    method: "POST",
    body: JSON.stringify(payload)
  });

  // Determine if it's her
  const isHer = name.toLowerCase() === HER_NAME.toLowerCase();

  // Send email ONLY if she is playing
  if (isHer) {
    fetch("/.netlify/functions/notify", {
      method: "POST",
      body: JSON.stringify({
        name,
        module: "Module 1 — Identity Entry",
        isHer
      })
    });
  }

  // Update session
  updateSession("Module 1");

  return true;
}
/***********************
 * IDENTITY → GAME TRANSITION
 ***********************/
identityForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = playerNameInput.value.trim();
  if (!name) {
    identityStatus.textContent = "The spirit needs a name to remember.";
    return;
  }

  playerName = name;
  startButton.disabled = true;
  identityStatus.textContent = "Listening to the stars…";

  await logIdentity(name);

identityStatus.textContent = "The spirit remembers you.";

  setTimeout(() => {
    startGameTransition();
  }, 700);
});

function startGameTransition() {
  gsap.to(identityScreen, {
    opacity: 0,
    duration: 0.7,
    onComplete: () => {
      identityScreen.style.display = "none";
    }
  });

  gameScreen.style.pointerEvents = "auto";
  gsap.to(gameScreen, {
    opacity: 1,
    duration: 0.8
  });

  gsap.to("#cosmicCharacter", {
    y: -8,
    duration: 2,
    yoyo: true,
    repeat: -1
  });

  initGame();
}
</script>

</html>

